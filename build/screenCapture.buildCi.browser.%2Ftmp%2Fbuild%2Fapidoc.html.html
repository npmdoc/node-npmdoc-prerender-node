<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/prerender/prerender-node#readme">prerender-node (v2.7.1)</a>
</h1>
<h4>express middleware for serving prerendered javascript-rendered pages for SEO</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.prerender-node">module prerender-node</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.prerender-node">
            function <span class="apidocSignatureSpan"></span>prerender-node
            <span class="apidocSignatureSpan">(req, res, next)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.afterRenderFn">
            function <span class="apidocSignatureSpan">prerender-node.</span>afterRenderFn
            <span class="apidocSignatureSpan">(err, req, prerender_res)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.beforeRenderFn">
            function <span class="apidocSignatureSpan">prerender-node.</span>beforeRenderFn
            <span class="apidocSignatureSpan">(req, done)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.blacklisted">
            function <span class="apidocSignatureSpan">prerender-node.</span>blacklisted
            <span class="apidocSignatureSpan">(blacklist)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.buildApiUrl">
            function <span class="apidocSignatureSpan">prerender-node.</span>buildApiUrl
            <span class="apidocSignatureSpan">(req)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.getPrerenderServiceUrl">
            function <span class="apidocSignatureSpan">prerender-node.</span>getPrerenderServiceUrl
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.getPrerenderedPageResponse">
            function <span class="apidocSignatureSpan">prerender-node.</span>getPrerenderedPageResponse
            <span class="apidocSignatureSpan">(req, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.gunzipResponse">
            function <span class="apidocSignatureSpan">prerender-node.</span>gunzipResponse
            <span class="apidocSignatureSpan">(response, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.plainResponse">
            function <span class="apidocSignatureSpan">prerender-node.</span>plainResponse
            <span class="apidocSignatureSpan">(response, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.set">
            function <span class="apidocSignatureSpan">prerender-node.</span>set
            <span class="apidocSignatureSpan">(name, value)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.shouldShowPrerenderedPage">
            function <span class="apidocSignatureSpan">prerender-node.</span>shouldShowPrerenderedPage
            <span class="apidocSignatureSpan">(req)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.prerender-node.whitelisted">
            function <span class="apidocSignatureSpan">prerender-node.</span>whitelisted
            <span class="apidocSignatureSpan">(whitelist)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">prerender-node.</span>crawlerUserAgents</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">prerender-node.</span>extensionsToIgnore</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">prerender-node.</span>prerenderServerRequestOptions</span>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.prerender-node" id="apidoc.module.prerender-node">module prerender-node</a></h1>


    <h2>
        <a href="#apidoc.element.prerender-node.prerender-node" id="apidoc.element.prerender-node.prerender-node">
        function <span class="apidocSignatureSpan"></span>prerender-node
        <span class="apidocSignatureSpan">(req, res, next)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">prerender-node = function (req, res, next) {
  if(!prerender.shouldShowPrerenderedPage(req)) return next();

  prerender.beforeRenderFn(req, function(err, cachedRender) {

    if (!err &amp;&amp; cachedRender) {
      if (typeof cachedRender == 'string') {
        res.writeHead(200, {
          "Content-Type": "text/html"
        });
        return res.end(cachedRender);
      } else if (typeof cachedRender == 'object') {
        res.writeHead(cachedRender.status || 200, {
          "Content-Type": "text/html"
        });
        return res.end(cachedRender.body || '');
      }
    }

    prerender.getPrerenderedPageResponse(req, function(err, prerenderedResponse){
      prerender.afterRenderFn(err, req, prerenderedResponse);

      if(prerenderedResponse){
        res.writeHead(prerenderedResponse.statusCode, prerenderedResponse.headers);
        return res.end(prerenderedResponse.body);
      } else {
        next(err);
      }
    });
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.afterRenderFn" id="apidoc.element.prerender-node.afterRenderFn">
        function <span class="apidocSignatureSpan">prerender-node.</span>afterRenderFn
        <span class="apidocSignatureSpan">(err, req, prerender_res)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">afterRenderFn = function (err, req, prerender_res) {
  if (!this.afterRender) return;

  this.afterRender(err, req, prerender_res);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    "Content-Type": "text/html"
  });
  return res.end(cachedRender.body || '');
}
    }

    prerender.getPrerenderedPageResponse(req, function(err, prerenderedResponse){
prerender.<span class="apidocCodeKeywordSpan">afterRenderFn</span>(err, req, prerenderedResponse);

if(prerenderedResponse){
  res.writeHead(prerenderedResponse.statusCode, prerenderedResponse.headers);
  return res.end(prerenderedResponse.body);
} else {
  next(err);
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.beforeRenderFn" id="apidoc.element.prerender-node.beforeRenderFn">
        function <span class="apidocSignatureSpan">prerender-node.</span>beforeRenderFn
        <span class="apidocSignatureSpan">(req, done)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">beforeRenderFn = function (req, done) {
  if (!this.beforeRender) return done();

  return this.beforeRender(req, done);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
var request = require('request')
  , url = require('url')
  , zlib = require('zlib');

var prerender = module.exports = function(req, res, next) {
  if(!prerender.shouldShowPrerenderedPage(req)) return next();

  prerender.<span class="apidocCodeKeywordSpan">beforeRenderFn</span>(req, function(err, cachedRender) {

if (!err &amp;&amp; cachedRender) {
  if (typeof cachedRender == 'string') {
    res.writeHead(200, {
      "Content-Type": "text/html"
    });
    return res.end(cachedRender);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.blacklisted" id="apidoc.element.prerender-node.blacklisted">
        function <span class="apidocSignatureSpan">prerender-node.</span>blacklisted
        <span class="apidocSignatureSpan">(blacklist)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">blacklisted = function (blacklist) {
  prerender.blacklist = typeof blacklist === 'string' ? [blacklist] : blacklist;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
app.use(require('prerender-node').whitelisted(['/search', '/users/.*/profile']));
```

### Blacklist

Blacklist a single url path or multiple url paths. Compares using regex, so be specific when possible. If a blacklist is supplied
, all url's will be prerendered except ones containing a blacklist path.
```js
app.use(require('prerender-node').<span class="apidocCodeKeywordSpan">blacklisted</span>('^/search'));
```
```js
app.use(require('prerender-node').blacklisted(['/search', '/users/.*/profile']));
```

### beforeRender
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.buildApiUrl" id="apidoc.element.prerender-node.buildApiUrl">
        function <span class="apidocSignatureSpan">prerender-node.</span>buildApiUrl
        <span class="apidocSignatureSpan">(req)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">buildApiUrl = function (req) {
  var prerenderUrl = prerender.getPrerenderServiceUrl();
  var forwardSlash = prerenderUrl.indexOf('/', prerenderUrl.length - 1) !== -1 ? '' : '/';

  var protocol = req.connection.encrypted ? "https" : "http";
  if (req.headers['cf-visitor']) {
    var match = req.headers['cf-visitor'].match(/"scheme":"(http|https)"/);
    if (match) protocol = match[1];
  }
  if (req.headers['x-forwarded-proto']) {
    protocol = req.headers['x-forwarded-proto'].split(',')[0];
  }
  if (this.protocol) {
    protocol = this.protocol;
  }
  var fullUrl = protocol + "://" + (this.host || req.headers['x-forwarded-host'] || req.headers['host']) + req.url;
  return prerenderUrl + forwardSlash + fullUrl;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
};


prerender.prerenderServerRequestOptions = {};

prerender.getPrerenderedPageResponse = function(req, callback) {
var options = {
  uri: url.parse(prerender.<span class="apidocCodeKeywordSpan">buildApiUrl</span>(req)),
  followRedirect: false,
  headers: {}
};
for (var attrname in this.prerenderServerRequestOptions) { options[attrname] = this.prerenderServerRequestOptions[attrname]; }
if (this.forwardHeaders === true) {
  Object.keys(req.headers).forEach(function(h) {
    // Forwarding the host header can cause issues with server platforms that require it to match the URL
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.getPrerenderServiceUrl" id="apidoc.element.prerender-node.getPrerenderServiceUrl">
        function <span class="apidocSignatureSpan">prerender-node.</span>getPrerenderServiceUrl
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getPrerenderServiceUrl = function () {
  return this.prerenderServiceUrl || process.env.PRERENDER_SERVICE_URL || 'http://service.prerender.io/';
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  response.body = content;
  callback(null, response);
});
};


prerender.buildApiUrl = function(req) {
var prerenderUrl = prerender.<span class="apidocCodeKeywordSpan">getPrerenderServiceUrl</span>();
var forwardSlash = prerenderUrl.indexOf('/', prerenderUrl.length - 1) !== -1 ? '' : '/';

var protocol = req.connection.encrypted ? "https" : "http";
if (req.headers['cf-visitor']) {
  var match = req.headers['cf-visitor'].match(/"scheme":"(http|https)"/);
  if (match) protocol = match[1];
}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.getPrerenderedPageResponse" id="apidoc.element.prerender-node.getPrerenderedPageResponse">
        function <span class="apidocSignatureSpan">prerender-node.</span>getPrerenderedPageResponse
        <span class="apidocSignatureSpan">(req, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getPrerenderedPageResponse = function (req, callback) {
  var options = {
    uri: url.parse(prerender.buildApiUrl(req)),
    followRedirect: false,
    headers: {}
  };
  for (var attrname in this.prerenderServerRequestOptions) { options[attrname] = this.prerenderServerRequestOptions[attrname]; }
  if (this.forwardHeaders === true) {
    Object.keys(req.headers).forEach(function(h) {
      // Forwarding the host header can cause issues with server platforms that require it to match the URL
      if (h == 'host') {
        return;
      }
      options.headers[h] = req.headers[h];
    });
  }
  options.headers['User-Agent'] = req.headers['user-agent'];
  options.headers['Accept-Encoding'] = 'gzip';
  if(this.prerenderToken || process.env.PRERENDER_TOKEN) {
    options.headers['X-Prerender-Token'] = this.prerenderToken || process.env.PRERENDER_TOKEN;
  }

  request.get(options).on('response', function(response) {
    if(response.headers['content-encoding'] &amp;&amp; response.headers['content-encoding'] === 'gzip') {
      prerender.gunzipResponse(response, callback);
    } else {
      prerender.plainResponse(response, callback);
    }
  }).on('error', function(err) {
    callback(err);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  res.writeHead(cachedRender.status || 200, {
    "Content-Type": "text/html"
  });
  return res.end(cachedRender.body || '');
}
    }

    prerender.<span class="apidocCodeKeywordSpan">getPrerenderedPageResponse</span>(req, function(err, prerenderedResponse){
prerender.afterRenderFn(err, req, prerenderedResponse);

if(prerenderedResponse){
  res.writeHead(prerenderedResponse.statusCode, prerenderedResponse.headers);
  return res.end(prerenderedResponse.body);
} else {
  next(err);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.gunzipResponse" id="apidoc.element.prerender-node.gunzipResponse">
        function <span class="apidocSignatureSpan">prerender-node.</span>gunzipResponse
        <span class="apidocSignatureSpan">(response, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">gunzipResponse = function (response, callback) {
  var gunzip = zlib.createGunzip()
    , content = '';

  gunzip.on('data', function(chunk) {
    content += chunk;
  });
  gunzip.on('end', function() {
    response.body = content;
    delete response.headers['content-encoding'];
    delete response.headers['content-length'];
    callback(null, response);
  });
  gunzip.on('error', function(err){
    callback(err);
  });

  response.pipe(gunzip);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
  options.headers['Accept-Encoding'] = 'gzip';
  if(this.prerenderToken || process.env.PRERENDER_TOKEN) {
    options.headers['X-Prerender-Token'] = this.prerenderToken || process.env.PRERENDER_TOKEN;
  }

  request.get(options).on('response', function(response) {
    if(response.headers['content-encoding'] &amp;&amp; response.headers['content-encoding'] === 'gzip
') {
      prerender.<span class="apidocCodeKeywordSpan">gunzipResponse</span>(response, callback);
    } else {
      prerender.plainResponse(response, callback);
    }
  }).on('error', function(err) {
    callback(err);
  });
};
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.plainResponse" id="apidoc.element.prerender-node.plainResponse">
        function <span class="apidocSignatureSpan">prerender-node.</span>plainResponse
        <span class="apidocSignatureSpan">(response, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">plainResponse = function (response, callback) {
  var content = '';

  response.on('data', function(chunk) {
    content += chunk;
  });
  response.on('end', function() {
    response.body = content;
    callback(null, response);
  });
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
    options.headers['X-Prerender-Token'] = this.prerenderToken || process.env.PRERENDER_TOKEN;
  }

  request.get(options).on('response', function(response) {
    if(response.headers['content-encoding'] &amp;&amp; response.headers['content-encoding'] === 'gzip
') {
      prerender.gunzipResponse(response, callback);
    } else {
      prerender.<span class="apidocCodeKeywordSpan">plainResponse</span>(response, callback);
    }
  }).on('error', function(err) {
    callback(err);
  });
};

prerender.gunzipResponse = function(response, callback) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.set" id="apidoc.element.prerender-node.set">
        function <span class="apidocSignatureSpan">prerender-node.</span>set
        <span class="apidocSignatureSpan">(name, value)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">set = function (name, value) {
  this[name] = value;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```js
app.use(require('prerender-node'));
```

or if you have an account on [prerender.io](http://prerender.io) and want to use your token:

```js
app.use(require('prerender-node').<span class="apidocCodeKeywordSpan">set</span>('prerenderToken', 'YOUR_TOKEN
'));
```

`Note` If you're testing locally, you'll need to run the [prerender server](https://github.com/prerender/prerender) locally
 so that it has access to your server.

This middleware is tested with Express3 and Express4, but has no explicit dependency on either.

## Testing
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.shouldShowPrerenderedPage" id="apidoc.element.prerender-node.shouldShowPrerenderedPage">
        function <span class="apidocSignatureSpan">prerender-node.</span>shouldShowPrerenderedPage
        <span class="apidocSignatureSpan">(req)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">shouldShowPrerenderedPage = function (req) {
  var userAgent = req.headers['user-agent']
    , bufferAgent = req.headers['x-bufferbot']
    , isRequestingPrerenderedPage = false;

  if(!userAgent) return false;
  if(req.method != 'GET' &amp;&amp; req.method != 'HEAD') return false;

  //if it contains _escaped_fragment_, show prerendered page
  var parsedQuery = url.parse(req.url, true).query;
  if(parsedQuery &amp;&amp; parsedQuery['_escaped_fragment_'] !== undefined) isRequestingPrerenderedPage = true;

  //if it is a bot...show prerendered page
  if(prerender.crawlerUserAgents.some(function(crawlerUserAgent){ return userAgent.toLowerCase().indexOf(crawlerUserAgent.toLowerCase
()) !== -1;})) isRequestingPrerenderedPage = true;

  //if it is BufferBot...show prerendered page
  if(bufferAgent) isRequestingPrerenderedPage = true;

  //if it is a bot and is requesting a resource...dont prerender
  if(prerender.extensionsToIgnore.some(function(extension){return req.url.toLowerCase().indexOf(extension) !== -1;})) return false
;

  //if it is a bot and not requesting a resource and is not whitelisted...dont prerender
  if(Array.isArray(this.whitelist) &amp;&amp; this.whitelist.every(function(whitelisted){return (new RegExp(whitelisted)).test(req.url) ===
false;})) return false;

  //if it is a bot and not requesting a resource and is not blacklisted(url or referer)...dont prerender
  if(Array.isArray(this.blacklist) &amp;&amp; this.blacklist.some(function(blacklisted){
    var blacklistedUrl = false
      , blacklistedReferer = false
      , regex = new RegExp(blacklisted);

    blacklistedUrl = regex.test(req.url) === true;
    if(req.headers['referer']) blacklistedReferer = regex.test(req.headers['referer']) === true;

    return blacklistedUrl || blacklistedReferer;
  })) return false;

  return isRequestingPrerenderedPage;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...


var request = require('request')
  , url = require('url')
  , zlib = require('zlib');

var prerender = module.exports = function(req, res, next) {
  if(!prerender.<span class="apidocCodeKeywordSpan">shouldShowPrerenderedPage</span>(req)) return next();

  prerender.beforeRenderFn(req, function(err, cachedRender) {

if (!err &amp;&amp; cachedRender) {
  if (typeof cachedRender == 'string') {
    res.writeHead(200, {
      "Content-Type": "text/html"
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.prerender-node.whitelisted" id="apidoc.element.prerender-node.whitelisted">
        function <span class="apidocSignatureSpan">prerender-node.</span>whitelisted
        <span class="apidocSignatureSpan">(whitelist)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">whitelisted = function (whitelist) {
  prerender.whitelist = typeof whitelist === 'string' ? [whitelist] : whitelist;
  return this;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

# Customization

### Whitelist

Whitelist a single url path or multiple url paths. Compares using regex, so be specific when possible. If a whitelist is supplied
, only urls containing a whitelist path will be prerendered.
```js
app.use(require('prerender-node').<span class="apidocCodeKeywordSpan">whitelisted</span>('^/search'));
```
```js
app.use(require('prerender-node').whitelisted(['/search', '/users/.*/profile']));
```

### Blacklist
...</pre></li>
    </ul>








</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>